# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Message Queue –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–∏–≥

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É EPUB –∫–Ω–∏–≥ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot ‚Üí Message Queue ‚Üí Processing Function ‚Üí Database
     ‚Üì              ‚Üì              ‚Üì                ‚Üì
  –ó–∞–≥—Ä—É–∂–∞–µ—Ç    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤    –¢—Ä–∏–≥–≥–µ—Ä        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   –∫–Ω–∏–≥—É        –æ—á–µ—Ä–µ–¥—å       –∑–∞–ø—É—Å–∫–∞–µ—Ç      –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏
                –º–≥–Ω–æ–≤–µ–Ω–Ω–æ      —Ñ—É–Ω–∫—Ü–∏—é        —É–≤–µ–¥–æ–º–ª—è–µ—Ç
```

## üìã –®–∞–≥–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Message Queue

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Yandex Cloud Console** ‚Üí **Message Queue**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –æ—á–µ—Ä–µ–¥—å:
   - **–ò–º—è**: `book-processing-queue`
   - **–¢–∏–ø**: Standard
   - **–†–µ–≥–∏–æ–Ω**: ru-central1

3. –ü–æ–ª—É—á–∏—Ç–µ URL –æ—á–µ—Ä–µ–¥–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:

```bash
# Message Queue –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
MESSAGE_QUEUE_URL=https://message-queue.api.cloud.yandex.net/your-queue-url
AWS_REGION=ru-central1
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: `AWS_ACCESS_KEY_ID` –∏ `AWS_SECRET_ACCESS_KEY` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –≤–∞—à–∏—Ö GitHub Actions —Å–µ–∫—Ä–µ—Ç–∞—Ö –∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é **Cloud Function**:
   - **–ò–º—è**: `book-processing-function`
   - **Runtime**: Python 3.9
   - **Entrypoint**: `queue_handler.handler`
   - **Memory**: 4096 MB
   - **Timeout**: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)

2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `queue_handler.py` –∏ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Cloud Functions** ‚Üí **–¢—Ä–∏–≥–≥–µ—Ä—ã**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä:
   - **–¢–∏–ø**: Message Queue
   - **–û—á–µ—Ä–µ–¥—å**: `book-processing-queue`
   - **–§—É–Ω–∫—Ü–∏—è**: `book-processing-function`
   - **Batch size**: 1
   - **Visibility timeout**: 600 —Å–µ–∫—É–Ω–¥

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

–ó–∞–º–µ–Ω–∏—Ç–µ –∫–æ–¥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Message Queue:

```python
# –í index.py
from book_adder import BookAdder

book_adder = BookAdder()

# –í handle_document
book_id = book_adder.add_new_book(user_id, chat_id, local_file_path, sending_mode, bot)
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
```bash
TOKEN=your-telegram-bot-token
MESSAGE_QUEUE_URL=https://message-queue.api.cloud.yandex.net/your-queue-url
AWS_REGION=ru-central1
# AWS_ACCESS_KEY_ID –∏ AWS_SECRET_ACCESS_KEY —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitHub Actions
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```bash
TOKEN=your-telegram-bot-token
# YDB –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–µ –∂–µ, —á—Ç–æ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
YDB_ENDPOINT=your-ydb-endpoint
YDB_DATABASE=your-ydb-database
# AWS_ACCESS_KEY_ID –∏ AWS_SECRET_ACCESS_KEY —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitHub Actions
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥—å
- –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –æ –∫–Ω–∏–≥–∞—Ö

### –õ–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ EPUB —Ñ–∞–π–ª–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏** - —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ 10 –º–∏–Ω—É—Ç
2. **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** - –∫–Ω–∏–≥–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å —Å—Ä–∞–∑—É
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
cd /Users/matvey/Documents/GitHub/PartyBook
python app/queue_handler.py
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ—á–µ—Ä–µ–¥—å:
```python
from queue_sender import QueueSender

sender = QueueSender()
success = sender.send_test_message()
print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {success}")
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏:
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Message Queue** ‚Üí –≤–∞—à–∞ –æ—á–µ—Ä–µ–¥—å
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
3. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –æ—á–µ—Ä–µ–¥–∏** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `MESSAGE_QUEUE_URL`
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `AWS_ACCESS_KEY_ID` –∏ `AWS_SECRET_ACCESS_KEY` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitHub Actions —Å–µ–∫—Ä–µ—Ç–∞—Ö
3. **–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
4. **–¢–∞–π–º–∞—É—Ç —Ñ—É–Ω–∫—Ü–∏–∏** - —É–≤–µ–ª–∏—á—å—Ç–µ timeout –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ:
1. –£–≤–µ–ª–∏—á—å—Ç–µ **batch size** —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–¥–æ 10)
2. –£–≤–µ–ª–∏—á—å—Ç–µ **memory** —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–æ 8GB)
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–Ω–∏–≥
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **dead letter queue** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
